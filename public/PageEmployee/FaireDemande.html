<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace employer</title>
    <link rel="icon" href="/assets/images1/logo.jpg">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/bootstrap/css/bootstrap.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="/assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="/cssDTB/space.css" />
    <link rel="stylesheet" type="text/css" href="cssDTB/leaveRequest.css" />
    <link rel="stylesheet" type="text/css" href="/assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="/assets/fontawesome-free-6.4.0-web/css/all.css" />
    <script>
        var accumulate = parseFloat('<%= user.leave_taked %>');
        var openLeave = parseFloat('<%= user.remaining_leave %>');
    </script>
</head>

<body>
    <div class="element-container">
    
        <div class="mt-3 menu-container">
            <div class="d-flex justify-content-between menu">
                <div class="d-flex justy-content-start align-items-center">
                    <div class="logo">
                        <img class="img-logo" src="assets/images/solumada-logo.png" />
                    </div> 
                    <div class="notif notif-sm justify-content-end mt-2">
                        <button onclick="openNotif(this)" class="notif-btn">
                            <i class="fa-solid fa-bell icons mx-3"></i>
                            <span id="numberNotification" class="badge badge-danger">0</span>
                        </button>
                        <button onclick="logOut()">
                            <i class="fa-solid fa-power-off icons mx-3"></i>
                        </button>
                    </div>
                </div>
                <div class="menu mt-1">
                    <a href="/mySpace" class="text-menu mx-2">
                        Accueil
                    </a>
                    <a href="/employee" class="text-menu mx-2">
                        Mon pointage
                    </a>
                    <a href="RequestLeave" class="text-menu active-menu mx-2">
                        Demande d'absence
                    </a>
                    <a href="SalaryAdvance" class="text-menu mx-2">
                        Avance sur salaire
                    </a>
                    <a href="News" class="text-menu mx-2">
                        Solumada News
                    </a>
                </div>
                <div class="notif notif-lg justify-content-end mt-2">
                    <button onclick="openNotif(this)" class="notif-btn">
                        <i class="fa-solid fa-bell icons mx-3"></i>
                        <span id="numberNotification" class="badge badge-danger">0</span>
                    </button>
                    <button onclick="logOut()">
                        <i class="fa-solid fa-power-off icons mx-3"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="content-home my-2">
            <div class="container mb-3">
                <div class="header-request">
                    <h6 class="text-historic">Historique</h6>
                    <div class="row px-3">
                        <div class="col-md-6">
                            <!-- aprouve, refuser, en traitement , et en attente -->
                            <div class="grid-item">
                                <div class="text-center">
                                    <div class="case-number">
                                        <div class="d-flex">
                                            <i class="fa-solid fa-circle-check icon-check"></i>
                                            <p class="text-title w-100">Approuver</p>
                                        </div>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <p id="approved" class="text-number">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="case-number">
                                        <div class="d-flex items-center justify-content-center flex-column">
                                            <i class="fa-solid fa-circle-xmark icon-x"></i>
                                            <p class="text-title w-100">Refuser</p>
                                        </div>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <p id="declined" class="text-number">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="case-number">
                                        <div class="d-flex">
                                            <i class="fa-solid fa-hourglass-start icon-progress"></i>
                                            <p class="text-title w-100">En traitement</p>
                                        </div>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <p id="progress" class="text-number">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="case-number">
                                        <div class="d-flex">
                                            <i class="fa-solid fa-hourglass-start icon-wait"></i>
                                            <p class="text-title w-100">En attente</p>
                                        </div>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <p id="pending" class="text-number">0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="text-solde" id="thisYear"></p>
                                    <div id="accumulate" class="accumulate-content">
                                        
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <p class="text-solde" id="lastYear">Ouvert</p>
                                    <div id="openLeave" class="open-content">
                                        
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-2">
                    <div class="buttons-tab">
                        <button id="makeRequest" class="switch-button active-btn">
                           Demande congé
                        </button>
                        <button id="myRequest" class="switch-button">
                            Mes requêtes
                        </button>
                        <button id="myUpcoming" class="switch-button">
                            Congés a vénir
                        </button>
                    </div>
                   <div>
                        <div id="notification" class="notice-success">
                           Requête envoyé
                        </div>
                   </div>
                </div>
                
                <div id="container-none" class="container-none mt-2">
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <p class="text-nothing">Aucune donnée pour l'instant</p>
                            <i class="fa-solid fa-folder-open text-nothing"></i>
                        </div>
                    </div>
                </div>
                <div id="container-make" class="container-make mt-2">
                        <h5 class="">
                            <span class="point-text">AUTORISATION D'ABSENCE / REGULARISATION D'ABSENCE</span>
                        </h5>
                        <label for="" class="request-warning">
                            Toutes demandes de : - congés > à 3 jours doivent être déposées au moins 10 jours ou une (1) semaine ouvrable,
                            - congés et permissions < à 3 jours à déposer dans les 48 heures ouvrables avant leurs dates effectives, sauf pour les congés
                            maladies ou Décès.
                        </label>
                        <div class="row">
                            <div class="col-md-6 d-flex">
                                <p class="point-text">Nom et prénoms :</p>
                                <p class="text-infos mx-2"><%= user.first_name %> <%= user.last_name %></p>
                            </div>
                            <div class=" col-md-6 d-flex">
                                <p class="point-text">Prenom usuel :</p>
                                <p class="text-infos mx-2"><%= user.usuel %></p>
                            </div>
                        </div>
                        <div class="row col-md-9 p-0">
                            <div class="col-md-4 d-flex w-100">
                                <p class="point-text">Matricule :</p>
                                <p class="text-infos mx-2"><%= user.matr %></p>
                            </div>
                            <div class="col-md-4 d-flex w-100">
                                <p class="point-text">M-code :</p>
                                <p class="text-infos mx-2" id="code"><%= user.m_code %></p>
                            </div>
                            <div class="col-md-4 d-flex w-100">
                                <p class="point-text">Shift :</p>
                                <p class="text-infos mx-2" id="shift"><%= user.shift %></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-9">
                                <div class="row col-md-12 p-0">
                                    <div class="col-md-4 d-flex w-100">
                                        <p class="point-text">Periode solicitée :</p>
                                    </div>
                                    <div class="col-md-4 d-flex justify-content-between w-100">
                                        <p class="point-text ">Date début :</p>
                                        <input class="mx-1 date value" id="startDate" type="date" />
                                    </div>
                                    <div class="col-md-4 d-flex justify-content-between w-100">
                                        <p class="point-text ">Heure :</p>
                                        <input class="mx-1 date value" id="startTime" type="time" />
                                    </div>
                                </div>
                                <div class="row col-md-12 p-0">
                                    <div class="col-md-4 d-flex w-100">
                                    
                                    </div>
                                    <div class="col-md-4 d-flex justify-content-between w-100">
                                        <p class="point-text ">Date fin :</p>
                                        <input class="mx-1 date value" id="endDate" type="date" />
                                    </div>
                                    <div class="col-md-4 d-flex justify-content-between w-100">
                                        <p class="point-text ">Heure :</p>
                                        <input class="mx-1 date value" id="endTime" type="time" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 align-items-center justify-content-center">
                                <div class="day-number">
                                    <p class="point-text">Nb de jour :</p>
                                    <p id="dayNumber">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <p class="point-text mb-2">Motifs ou congé souhaiter :</p>
                                <textarea  class="value" id="motif"></textarea>
                            </div>
                            <div class="col-md-6">
                                <p class="point-text mb-2">Récupération :</p>
                                <textarea id="recovery"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between flex-wrap mt-3">
                            <div class="d-flex justify-content-center align-items-center">
                                <div>
                                    <p class="text-infos">Priorité haute </p>
                                </div>
                                <div>
                                    <input type="checkbox" id="toggle" class="hidden-checkbox">
                                    <label for="toggle" class="toggle-label ml-3"></label>
                                </div>
                            </div>
                            <div class="d-flex justify-content-center align-items-center">
                                <input type="file" class="d-none" id="join">
                                <div class="d-flex"><i id="fileOk"  class="fa-solid fa-file-circle-check fa-xl file-ok mx-1 mt-4"></i><button id="joinFile" onclick="triggerButton()" class="btn btn-md btn-secondary">Joindre fichier <i class="fa-solid fa-paperclip"></i></button></div>
                                <button id="sendRequest" class="btn btn-md btn-success mx-4">Envoyer demande <i class="fa-solid fa-paper-plane-o"></i></button>
                                <div class="snippet p-3" id="loading" data-title="dot-pulse">
                                    <div class="stage">
                                        <div class="dot-pulse"></div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                </div>
                <div id="container-request" class="container-request mt-2">
                
                </div>
                <div id="container-upcoming" class="container-request mt-2">
                    
                </div>
            </div>
            
            
            <!-- notification modal -->
            <div class="notification-modal">
                <h2>
                    <i class="fa-solid fa-bell icons"></i>
                    Notifications:
                </h2>
                <div class="notification-options">
                    <button type="button" class="mark" onclick="markAllAsRead()">Marquer tous comme lu</button>
                    <button type="button" class="delete" onclick="removeAllNotifications()">Effacer les notifications</button>
                </div>
                <div id="notifContent" class="notification-list">
                    
                </div>
            </div>
        </div>
    </div>
    <script>
        function openNotif(button) {
            let notif_div = document.querySelector('.notification-modal');
            let buttons = [...document.querySelectorAll('.notif button.notif-btn')];
            console.log(buttons)
            // close modal
            if (button.classList.contains('selected')) {
                buttons.forEach(btn => 
                    btn.classList.remove('selected')
                )
                notif_div.classList.replace('show', 'hide');
            } else {
                // open modal
                buttons.map(btn => btn.classList.add('selected'));

                if (notif_div.classList.contains('hide')) {
                    notif_div.classList.replace('hide', 'show');
                } else {
                    notif_div.classList.add('show');
                }
                // click away 
                document.onclick = (e) => {
                    // close the notification modal when user click outsite its content
                    if (!e.target.closest('.notification-modal') && 
                    !e.target.closest('.notif')) {
                        buttons.forEach(btn => 
                            btn.classList.remove('selected')
                        )
                        notif_div.classList.remove('show');
                        notif_div.classList.remove('hide');
                    }
                }
            }
        }

        function logOut(){
            window.location = "/exit_a";
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"></script>
    <script src="/js_code/socket.js"></script>
    <script>
        var socket = io();
        socket.on('<%= codeUser %>',function (theNotif){
            pushNotification(theNotif)
            const notification = new Notification(theNotif.title, {
                body: `${theNotif.content.replace("<br>","")}`,
                    icon:  '../assets/images1/logo.jpg',
            })
        })
        socket.on("isTreated", function (response){
            if (response[1].status == "approved"){
                dropElementById(response[0])
                Approves.push(response[1]);
                Approved(Approves)
                $("#accumulate").html((Approves[Approves.length - 1].acc - Approves[Approves.length - 1].rest))
                $("#openLeave").html(Approves[Approves.length - 1].rest)
            }
            else {
                replaceElementByIdPending(response[0],response[1])
            }
        })
        function pushNotification(theNotif){
            // Add a notification according to socket
            var notifElement = `
                        <div id="${theNotif._id}" class="notification-item ${theNotif.isSeen ? 'seen' : ''}" onClick="markAsRead('${theNotif._id}')">
                            <h1>${theNotif.title}</h1>
                            <p class="message">${theNotif.content}</p>
                            <div class="date-time">
                                <span>${theNotif.datetime}</span>
                            </div>
                            <button type="button" class="remove-notif-btn" onClick="removeNotification('${theNotif._id}')"><i class="fa-solid fa-times"></i></button>
                        </div>
                        `
            $("#notifContent").prepend(notifElement);
            $("span#numberNotification").each((i, element) => {
                        $(element).text(parseInt($(element).text()) + 1)
                    });
                $('.notification-options > button.mark').prop('disabled', false);
                $('.notification-options > button.delete').prop('disabled', false);
        }
        function setnotification(theUser){
            $.ajax({
                url: "/getNotifications",
                method: "POST",
                data: {code:theUser},
                success: function (data) {
                    var notifElement = ""; 
                    data.forEach(element => {
                        notifElement += `
                        <div id="${element._id}" class="notification-item ${element.isSeen ? 'seen' : ''}" onClick="markAsRead('${element._id}')">
                            <h1>${element.title}</h1>
                            <p class="message">${element.content}</p>
                            <div class="date-time">
                                <span>${element.datetime}</span>
                            </div>
                            <button type="button" class="remove-notif-btn" onClick="removeNotification('${element._id}')"><i class="fa-solid fa-times"></i></button>
                        </div>
                        `
                    });
                    let notificationCount = data.filter(e => !e.isSeen).length;
                    $("span#numberNotification").each((i, element) => {
                        $(element).text(notificationCount)
                    });
                    $("#notifContent").html(notifElement);
                    // disable markAsRead and ClearNotifications
                    // if all notifications read
                    if (notificationCount === 0) {
                        // disable marquer tous comme lu
                        $('.notification-options > button.mark').attr('disabled', '');
                    }
                    if (data.length === 0) {
                        // disable effacer les notifications
                        $('.notification-options > button.delete').attr('disabled', '');
                    }
                }
            })
        }
        setnotification('<%= codeUser %>');

        function removeNotification(id) {
            // supprimer une notification
            // send request here
            $.ajax({
                url: `/remove-notification/${id}`,
                method: "DELETE",
                data: { notifId: id },
                success: function (data) {
                    if (data.ok) {
                        $(`#${id}`).addClass('removing');
                        setTimeout(() => {
                            $(`#${id}`).remove();
                        }, 200);
                        let notifCount = $("#numberNotification").text();
                        if (notifCount > 0)np
                            $("span#numberNotification").each((i, element) => {
                                $(element).text(notifCount - 1)
                            });
                        // disable effacer les notifications
                        if ($('.notification-item').length === 0)
                            $('.notification-options > button.delete').attr('disabled', '');
                    } else {
                        console.log(data.message)
                    }
                },
                error: function(err) {
                    console.error(err)
                }
            });

        }

        function removeAllNotifications() {
            // supprimer toutes les notifications
            $.ajax({
                url: "/removeall-notification",
                method: "DELETE",
                success: function (data) {
                    if (data.ok) {
                        $('#notifContent > div').each((index, element) => {
                            setTimeout(() => {
                                $(element).addClass('removing');
                                setTimeout(() => {
                                    $("span#numberNotification").each((i, element) => {
                                        $(element).text(0)
                                    });
                                    $(element).remove();
                                }, 300);
                            }, index * 300);
                        });
                    } else {
                        console.log(data.message)
                    }
                },
                error: function(err) {
                    console.error(err)
                }
            });
        }

        function markAsRead(id) {
            // send request to the server
            if ($(`#${id}`).hasClass('seen')) return;
            
            $.ajax({
                url: `/markAsRead-notification/${id}`,
                method: "PUT",
                success: function (data) {
                    if (data.ok) {
                        $(`#${id}`).addClass('seen');
                        $(`#${id}`).removeAttr('onClick');
                        let notifCount = $("#numberNotification").text();
                        if (notifCount > 0)
                            $("span#numberNotification").each((i, element) => {
                                $(element).text(notifCount - 1)
                            });
                    } else {
                        console.log(data.message)
                    }
                },
                error: function(err) {
                    console.error(err)
                }
            });
        }

        function markAllAsRead() {
            $.ajax({
                url: "/markAsReadAll-notification",
                method: "PUT",
                success: function (data) {
                    if (data.ok) {
                        $('#notifContent > div').each((index, element) => {
                            $(element).addClass('seen');
                            $("span#numberNotification").each((i, element) => {
                                $(element).text(0)
                            });
                            
                            $('.notification-options > button.mark').attr('disabled', '');
                        });
                    } else {
                        console.log(data.message)
                    }
                },
                error: function(err) {
                    console.error(err)
                }
            });
        }
        function setSolde(accumulate,open){
            $("#thisYear").text(moment().format('YYYY'))
            $("#lastYear").text(moment().add(-1,"years").format('YYYY'));
            var showAccumulate = accumulate - open;
            $("#accumulate").text(showAccumulate);
            $("#openLeave").text(openLeave);
        }
        setSolde(accumulate,openLeave)

    </script>
    <script src="../jsDTB/LeaveRequest.js"></script>


</body>

</html>